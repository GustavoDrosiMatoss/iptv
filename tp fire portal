-- ==========================
-- Fun√ß√µes auxiliares compartilhadas
-- ==========================
local function createAndStartDungeon()
    print("[DEBUG] Criando e iniciando dungeon...")
    
    -- Criar dungeon
    local createArgs = {
        [1] = {
            [1] = {
                ["Event"] = "DungeonAction",
                ["Action"] = "Create"
            },
            [2] = "\12"
        }
    }
    pcall(function()
        game:GetService("ReplicatedStorage").BridgeNet2.dataRemoteEvent:FireServer(unpack(createArgs))
    end)
    print("‚úî Dungeon criada.")
    
    task.wait(3)

    -- Iniciar dungeon
    local startArgs = {
        [1] = {
            [1] = {
                ["Event"] = "DungeonAction",
                ["Action"] = "Start"
            },
            [2] = "\12"
        }
    }
    pcall(function()
        game:GetService("ReplicatedStorage").BridgeNet2.dataRemoteEvent:FireServer(unpack(startArgs))
    end)
    print("‚ñ∂ Dungeon iniciada.")
end

local function leaveDungeon()
    print("[AUTO-EXIT] Saindo da dungeon...")
    local args = {
        [1] = {
            [1] = { ["Event"] = "LeaveDungeon" },
            [2] = "\12"
        }
    }
    pcall(function()
        game:GetService("ReplicatedStorage").BridgeNet2.dataRemoteEvent:FireServer(unpack(args))
    end)
    task.wait(2)
end

local function getDistance(pos1, pos2)
    return (pos1 - pos2).Magnitude
end

-- ==========================
-- Boss alvo configur√°vel
-- ==========================
ConfigSystem.DefaultConfig.DungeonTargetBoss = ConfigSystem.DefaultConfig.DungeonTargetBoss or ""
ConfigSystem.CurrentConfig.DungeonTargetBoss = ConfigSystem.CurrentConfig.DungeonTargetBoss or ConfigSystem.DefaultConfig.DungeonTargetBoss

local targetBossName = ConfigSystem.CurrentConfig.DungeonTargetBoss

-- Fun√ß√£o para pegar nome real do NPC (com Title.Text se existir)
local function getNPCName(enemy)
    local titleObj = enemy:FindFirstChild("Title", true)
    if titleObj and titleObj:IsA("TextLabel") then
        return titleObj.Text
    end
    return enemy.Name
end

-- Fun√ß√£o que retorna inimigo (boss espec√≠fico ou mais pr√≥ximo)
local function getTargetEnemy()
    if not workspace:FindFirstChild("__Main") or not workspace.__Main:FindFirstChild("__Enemies") then
        return nil
    end
    
    local enemiesFolder = workspace.__Main.__Enemies.Server
    local player = game.Players.LocalPlayer
    local playerCharacter = player.Character
    if not playerCharacter or not playerCharacter:FindFirstChild("HumanoidRootPart") then return nil end
    
    local closestEnemy = nil
    local closestDistance = math.huge
    local playerPosition = playerCharacter.HumanoidRootPart.Position
    
    for _, enemy in pairs(enemiesFolder:GetChildren()) do
        local hp = enemy:GetAttribute("HP")
        if hp and hp > 0 and enemy:FindFirstChild("HumanoidRootPart") then
            local npcName = string.lower(getNPCName(enemy))
            
            if targetBossName ~= "" and string.lower(targetBossName) == npcName then
                -- Boss alvo encontrado, retorna direto
                return enemy
            elseif targetBossName == "" then
                -- Sem boss definido -> pega o mais pr√≥ximo
                local distance = (playerPosition - enemy.HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestEnemy = enemy
                end
            end
        end
    end
    
    return closestEnemy
end

local function moveToEnemy(enemy, currentTween)
    local tweenService = game:GetService("TweenService")
    local player = game.Players.LocalPlayer
    local playerCharacter = player.Character
    
    if not playerCharacter or not playerCharacter:FindFirstChild("HumanoidRootPart") or not enemy:FindFirstChild("HumanoidRootPart") then
        return false, currentTween
    end

    if currentTween then
        currentTween:Cancel()
    end

    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    currentTween = tweenService:Create(
        playerCharacter.HumanoidRootPart, 
        tweenInfo, 
        {CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)}
    )

    currentTween:Play()

    return true, currentTween
end

local function isInCastleTime()
    local hora = os.date("*t")
    local minuto = hora.min
    return (minuto >= 15 and minuto < 30) or (minuto >= 45 and minuto < 55)
end

-- ==========================
-- SISTEMA 1: Dungeon INF (Sair ap√≥s limpar)
-- ==========================
ConfigSystem.DefaultConfig.DungeonINF = ConfigSystem.DefaultConfig.DungeonINF or false
ConfigSystem.CurrentConfig.DungeonINF = ConfigSystem.CurrentConfig.DungeonINF or ConfigSystem.DefaultConfig.DungeonINF

local dungeonINFEnabled = ConfigSystem.CurrentConfig.DungeonINF
local currentTweenINF = nil
local lastEnemyCheckINF = tick()
local maxTimeWithoutEnemiesINF = 5

local function monitorDungeonINF()
    print("[DUNGEON INF] üéØ Sistema iniciado - Farma e sai quando acaba!")
    
    while dungeonINFEnabled do
        pcall(function()
            if ConfigSystem.CurrentConfig.AutoFarmDungeon then
                print("[DUNGEON INF] ‚ö†Ô∏è CONFLITO: Auto Farm Dungeon est√° ativo! Use apenas um sistema.")
                task.wait(5)
                return
            end

            if isInCastleTime() then
                if workspace:FindFirstChild("__Main") then
                    leaveDungeon()
                    print("[DUNGEON INF] üè∞ Saiu para o Castle Infernal!")
                end
                task.wait(60)
                return
            end

            if not workspace:FindFirstChild("__Main") then
                print("[DUNGEON INF] üö™ Fora da dungeon. Criando nova...")
                createAndStartDungeon()
                task.wait(5)
                lastEnemyCheckINF = tick()
            else
                local closestEnemy = getTargetEnemy()
                local currentTime = tick()

                if closestEnemy then
                    lastEnemyCheckINF = currentTime
                    print("[DUNGEON INF] ‚öîÔ∏è Atacando:", getNPCName(closestEnemy))

                    local success
                    success, currentTweenINF = moveToEnemy(closestEnemy, currentTweenINF)
                    
                    if success then
                        local attempts = 0
                        while dungeonINFEnabled 
                              and closestEnemy.Parent 
                              and closestEnemy:GetAttribute("HP") 
                              and closestEnemy:GetAttribute("HP") > 0 
                              and attempts < 50 do
                            task.wait(0.2)
                            attempts += 1
                        end
                    end
                else
                    local timeWithoutEnemies = currentTime - lastEnemyCheckINF
                    
                    if timeWithoutEnemies >= maxTimeWithoutEnemiesINF then
                        print("[DUNGEON INF] ‚úÖ Dungeon limpa! Saindo...")
                        leaveDungeon()
                        task.wait(15)
                    else
                        local remaining = maxTimeWithoutEnemiesINF - timeWithoutEnemies
                        print(string.format("[DUNGEON INF] üîç Procurando inimigos... (%.1fs restantes)", remaining))
                        task.wait(1)
                    end
                end
            end
        end)

        task.wait(0.1)
    end

    if currentTweenINF then
        currentTweenINF:Cancel()
        currentTweenINF = nil
    end
    print("[DUNGEON INF] üõë Sistema desativado.")
end

-- ==========================
-- SISTEMA 2: Auto Farm Dungeon (Recriar infinito)
-- ==========================
ConfigSystem.DefaultConfig.AutoFarmDungeon = ConfigSystem.DefaultConfig.AutoFarmDungeon or false
ConfigSystem.CurrentConfig.AutoFarmDungeon = ConfigSystem.CurrentConfig.AutoFarmDungeon or ConfigSystem.DefaultConfig.AutoFarmDungeon

local autoFarmEnabled = ConfigSystem.CurrentConfig.AutoFarmDungeon
local currentTweenAuto = nil
local lastEnemyCheckAuto = tick()
local maxTimeWithoutEnemiesAuto = 1

local function monitorAutoFarm()
    print("[AUTO FARM] üîÑ Sistema iniciado - Farm infinito com recria√ß√£o!")

    while autoFarmEnabled do
        pcall(function()
            if ConfigSystem.CurrentConfig.DungeonINF then
                print("[AUTO FARM] ‚ö†Ô∏è CONFLITO: Dungeon INF est√° ativo! Use apenas um sistema.")
                task.wait(5)
                return
            end

            if isInCastleTime() then
                if workspace:FindFirstChild("__Main") then
                    leaveDungeon()
                    print("[AUTO FARM] üè∞ Saiu para o Castle Infernal!")
                end
                task.wait(60)
                return
            end

            if not workspace:FindFirstChild("__Main") then
                print("[AUTO FARM] üö™ Fora da dungeon. Criando nova...")
                createAndStartDungeon()
                task.wait(5)
                lastEnemyCheckAuto = tick()
            else
                local closestEnemy = getTargetEnemy()
                local currentTime = tick()

                if closestEnemy then
                    lastEnemyCheckAuto = currentTime
                    print("[AUTO FARM] ‚öîÔ∏è Atacando:", getNPCName(closestEnemy))

                    local success
                    success, currentTweenAuto = moveToEnemy(closestEnemy, currentTweenAuto)
                    
                    if success then
                        local attempts = 0
                        while autoFarmEnabled 
                              and closestEnemy.Parent 
                              and closestEnemy:GetAttribute("HP") 
                              and closestEnemy:GetAttribute("HP") > 0 
                              and attempts < 50 do
                            task.wait(0.2)
                            attempts += 1
                        end
                    end
                else
                    local timeWithoutEnemies = currentTime - lastEnemyCheckAuto
                    
                    if timeWithoutEnemies >= maxTimeWithoutEnemiesAuto then
                        print("[AUTO FARM] ‚ö° Recriando dungeon SUPER R√ÅPIDO!")
                        
                        if currentTweenAuto then
                            currentTweenAuto:Cancel()
                            currentTweenAuto = nil
                        end
                        
                        leaveDungeon()
                        task.wait(2)
                        
                        createAndStartDungeon()
                        task.wait(3)
                        lastEnemyCheckAuto = tick()
                    else
                        local remaining = maxTimeWithoutEnemiesAuto - timeWithoutEnemies
                        if math.floor(remaining * 10) % 5 == 0 then
                            print(string.format("[AUTO FARM] ‚ö° MODO TURBO: %.1fs sem mobs (recria em %.1fs)", timeWithoutEnemies, remaining))
                        end
                        task.wait(0.2)
                    end
                end
            end
        end)

        task.wait(0.1)
    end

    if currentTweenAuto then
        currentTweenAuto:Cancel()
        currentTweenAuto = nil
    end
    print("[AUTO FARM] üõë Sistema desativado.")
end

-- ==========================
-- TOGGLES + INPUT
-- ==========================
Tabs.dungeon:AddInput("DungeonTargetBoss", {
    Title = "üéØ Boss Alvo",
    Description = "Digite o nome do boss (ex: Cat God)",
    Default = ConfigSystem.CurrentConfig.DungeonTargetBoss,
    Placeholder = "Exemplo: Cat God",
    Callback = function(value)
        targetBossName = value
        ConfigSystem.CurrentConfig.DungeonTargetBoss = value
        ConfigSystem.SaveConfig()
        print("[DUNGEON] Boss alvo definido para:", value)
    end
})

Tabs.dungeon:AddToggle("DungeonINF", {
    Title = "üéØ Dungeon INF",
    Description = "Farma e sai quando limpa a dungeon",
    Default = ConfigSystem.CurrentConfig.DungeonINF,
    Flag = "DungeonINF",
    Callback = function(state)
        dungeonINFEnabled = state
        ConfigSystem.CurrentConfig.DungeonINF = state
        ConfigSystem.SaveConfig()

        if state then
            if ConfigSystem.CurrentConfig.AutoFarmDungeon then
                print("‚ö†Ô∏è Desativando Auto Farm para evitar conflitos...")
                autoFarmEnabled = false
                ConfigSystem.CurrentConfig.AutoFarmDungeon = false
                ConfigSystem.SaveConfig()
            end
            
            task.spawn(monitorDungeonINF)
        else
            if currentTweenINF then
                currentTweenINF:Cancel()
                currentTweenINF = nil
            end
        end
    end
})

Tabs.dungeon:AddToggle("AutoFarmDungeon", {
    Title = "‚ö° Auto Farm Dungeon TURBO",
    Description = "Farm SUPER R√ÅPIDO - recria em 1s sem inimigos!",
    Default = ConfigSystem.CurrentConfig.AutoFarmDungeon,
    Flag = "AutoFarmDungeon",
    Callback = function(state)
        autoFarmEnabled = state
        ConfigSystem.CurrentConfig.AutoFarmDungeon = state
        ConfigSystem.SaveConfig()

        if state then
            if ConfigSystem.CurrentConfig.DungeonINF then
                print("‚ö†Ô∏è Desativando Dungeon INF para evitar conflitos...")
                dungeonINFEnabled = false
                ConfigSystem.CurrentConfig.DungeonINF = false
                ConfigSystem.SaveConfig()
            end
            
            task.spawn(monitorAutoFarm)
        else
            if currentTweenAuto then
                currentTweenAuto:Cancel()
                currentTweenAuto = nil
            end
        end
    end
})
